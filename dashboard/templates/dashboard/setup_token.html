{% extends "account/login_base.html" %}

{% load bootstrap %}

{% block panel-header-title %}Token setup{% endblock %}

{% block panel-body %}
    <form id="signup_form" method="post" action="{% url "dashboard:token-setup" %}" autocapitalize="off" {% if form.is_multipart %} enctype="multipart/form-data"{% endif %}>
        {% csrf_token %}
        <div class="panel panel-default">
            <div class="panel-body">
                Dashboard needs to gain access to an AmCAT instance, to fetch saved
                queries. Although
                you need to enter your credentials below, this dashboard will never
                store your credentials directly. Instead, it requests an authentication
                token and uses that to access AmCAT in the future.
            </div>
        </div>

        {{ form|bootstrap }}

        <input type="submit" class="btn btn-primary" value="Get token">
    </form>

    <script type="text/javascript">
        let tokenBtn = $('#amcat_token-request-token');
        let tokenInput = $('#id_amcat_token');
        tokenInput.on('input', e => {
            let hasToken = tokenInput.val();
            if(hasToken) userInputs.val('');
            $('input[type=submit][value=Get\\ token]').val('Save');
        });
        tokenInput.trigger('input');

        let return_uri = hostname => `${location.origin}${location.pathname}?amcat_token=%25s&hostname=${hostname}`;
        tokenBtn.click(() => {
            let origin;
            try {
                let url = new URL($('#id_hostname').removeClass('error').val());
                origin = url.origin;
                if(!url.protocol.match(/^https?:/))
                    throw "Invalid Protocol";

            }
            catch(e) {
                $('#id_hostname').closest('.form-group').addClass('has-error');
                return;
            }
            let url = `${origin}/request_token?return=${encodeURIComponent(return_uri(origin))}`;
            console.log(url);
            location.replace(url);
        });
    </script>
{% endblock %}
